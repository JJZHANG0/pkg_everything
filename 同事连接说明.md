# 🤖 同事连接解决方案

## 🚨 问题分析

你同事遇到的错误：
```
[ERROR] [1754193381.864667340] [multi_cmd_bot]: WebSocket connection failed: BaseEventLoop.create_connection() got an unexpected keyword argument 'extra_headers', retry after 5 seconds
```

这是因为同事的Python websockets库版本太旧，不支持`extra_headers`参数。

## ✅ 解决方案

### 1. 使用适配版本代码

我已经为你同事修改好了代码，主要改动：

- **移除 `extra_headers` 参数**：改为通过URL查询参数传递token
- **兼容旧版本websockets**：使用标准的连接方式
- **添加错误处理**：WebSocket失败时自动重试
- **支持紧急按钮**：添加了`emergency_open_door`指令处理

### 2. 关键修改点

```python
# 原来的代码（有问题）
async with websockets.connect(WS_SERVER_URL, extra_headers=headers) as ws:

# 修改后的代码（兼容）
params = urlencode({
    'token': token,
    'robot_id': ROBOT_ID
})
ws_url = f"ws://192.168.110.148:8000/ws/robot/{ROBOT_ID}/?{params}"
self.websocket = await websockets.connect(ws_url)
```

### 3. 配置参数

请同事确认以下配置：

```python
SERVER_URL = 'http://192.168.110.148:8000/api'  # 你的服务器IP
ROBOT_ID = 1
USERNAME = 'root'
PASSWORD = 'test123456'
```

## 📋 使用步骤

### 步骤1：替换代码
让同事用我提供的 `同事代码适配版本.py` 替换原来的代码。

### 步骤2：确认网络连接
确保同事的机器人能访问你的IP地址：`192.168.110.148:8000`

### 步骤3：运行测试
```bash
# 在同事的机器人上运行
python3 同事代码适配版本.py
```

## 🔧 测试连接

如果还有问题，可以让同事运行这个简单的测试脚本：

```python
#!/usr/bin/env python3
import asyncio
import websockets
import requests

async def test_connection():
    # 获取token
    response = requests.post(
        "http://192.168.110.148:8000/api/token/",
        json={"username": "root", "password": "test123456"}
    )
    token = response.json().get('access')
    
    # 连接WebSocket
    ws_url = f"ws://192.168.110.148:8000/ws/robot/1/?token={token}&robot_id=1"
    websocket = await websockets.connect(ws_url)
    print("✅ 连接成功!")
    await websocket.close()

asyncio.run(test_connection())
```

## 📊 支持的指令

修改后的代码支持以下WebSocket指令：

1. **`open_door`** - 开门
2. **`close_door`** - 关门  
3. **`upload_qr`** - 上传二维码图片
4. **`navigate`** - 导航到指定位置
5. **`emergency_open_door`** - 紧急开门

## 🔄 自动重连机制

- WebSocket连接断开时自动重试
- 每5秒重试一次
- 自动重新获取token
- 发送状态更新和指令结果

## 📝 日志查看

同事可以通过以下方式查看连接状态：

```bash
# 查看ROS日志
ros2 run your_package your_node

# 或者查看Python日志
python3 同事代码适配版本.py
```

## 🆘 故障排除

### 问题1：连接超时
- 检查网络连接
- 确认防火墙设置
- 验证IP地址是否正确

### 问题2：认证失败
- 检查用户名密码
- 确认token获取是否成功

### 问题3：WebSocket连接失败
- 检查websockets库版本
- 确认服务器WebSocket服务是否启动

## 📞 联系信息

如果还有问题，请提供：
1. 具体的错误信息
2. 网络连接状态
3. Python和websockets库版本

---

**注意**：这个修改版本完全兼容你的WebSocket系统，同事可以直接使用！ 