# 🔄 轮询模式启动指南

## 📋 系统已恢复到轮询模式

✅ **所有WebSocket相关代码已移除**
✅ **Django后端已恢复到轮询模式**
✅ **机器人客户端已切换到HTTP轮询**

## 🚀 启动步骤

### 1. 启动Django后端

```bash
# 进入Docker部署目录
cd docker_deploy

# 启动所有服务
docker-compose up -d
```

### 2. 验证后端服务

```bash
# 检查服务状态
docker-compose ps

# 查看后端日志
docker-compose logs backend
```

### 3. 启动机器人客户端

```bash
# 运行轮询客户端
python3 robot_client_polling.py
```

## 📡 通信方式

### 轮询机制
- **心跳**: 每5秒发送一次心跳到 `/api/robots/{robot_id}/heartbeat/`
- **状态更新**: 每5秒发送状态到 `/api/robots/{robot_id}/status/`
- **命令检查**: 每5秒检查新命令 `/api/robots/{robot_id}/commands/`
- **命令执行**: 收到命令后执行并返回结果

### API接口

#### 发送命令
```bash
POST /api/robots/{robot_id}/control/
{
    "action": "open_door"
}
```

#### 获取机器人状态
```bash
GET /api/robots/{robot_id}/status/
```

#### 获取待执行命令
```bash
GET /api/robots/{robot_id}/commands/
```

#### 发送命令执行结果
```bash
POST /api/robots/{robot_id}/execute_command/
{
    "command_id": "cmd_123",
    "result": "success",
    "message": "命令执行成功"
}
```

## 🔧 配置说明

### 机器人客户端配置
在 `robot_client_polling.py` 中修改：
```python
server_url = "http://localhost:8000"  # 修改为你的服务器地址
robot_id = "1"  # 修改为你的机器人ID
```

### 轮询间隔
默认每5秒轮询一次，可在客户端代码中修改：
```python
time.sleep(5)  # 修改轮询间隔
```

## 📁 文件说明

### 核心文件
1. **`robot_client_polling.py`** - 轮询模式机器人客户端
2. **`campus_delivery/core/views.py`** - 后端API接口（已移除WebSocket）
3. **`campus_delivery/campus_delivery/settings.py`** - Django设置（已移除Channels）
4. **`campus_delivery/entrypoint.sh`** - 启动脚本（已恢复runserver）

### 已移除的WebSocket文件
- `websocket_server_*.py` - WebSocket服务器
- `robot_test_client.py` - WebSocket测试客户端
- `campus_delivery/core/robot_websocket.py` - WebSocket消费者
- `campus_delivery/core/routing.py` - WebSocket路由

## 🔍 监控和调试

### 查看后端日志
```bash
docker-compose logs -f backend
```

### 查看机器人客户端日志
客户端会输出详细的轮询日志：
```
💓 心跳发送成功: 1
📊 状态更新成功: {...}
⏳ 暂无新命令
🔧 执行命令: open_door
✅ 命令执行结果已发送: open_door
```

### 网络监控
访问 `/superuser/network-monitor` 查看所有HTTP请求和响应。

## ✅ 优势

1. **简单可靠**: 基于HTTP，无需复杂的WebSocket连接管理
2. **易于调试**: 所有通信都是标准的HTTP请求/响应
3. **兼容性好**: 支持任何HTTP客户端
4. **稳定性高**: 不会因为连接断开而丢失消息

## 🔄 工作流程

1. **机器人启动**: 客户端开始轮询
2. **心跳通信**: 定期发送心跳保持在线状态
3. **状态同步**: 定期更新机器人状态
4. **命令检查**: 定期检查是否有新命令
5. **命令执行**: 收到命令后执行并返回结果
6. **循环继续**: 继续下一轮轮询

---

**状态**: ✅ 系统已恢复到轮询模式，可以开始使用 