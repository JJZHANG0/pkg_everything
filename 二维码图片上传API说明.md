# 📱 二维码图片上传API说明

## 接口概述
机器人通过摄像头拍摄二维码图片，上传到服务器进行识别和验证。

## 接口详情

### 接口地址
```
POST /api/robots/{robot_id}/upload_qr_image/
```

### 请求方式
- **方法**: POST
- **认证**: 需要JWT Token
- **Content-Type**: multipart/form-data

### 请求参数
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| qr_image | File | 是 | 二维码图片文件 |

### 请求示例
```bash
curl -X POST \
  http://localhost:8000/api/robots/1/upload_qr_image/ \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -F "qr_image=@/path/to/qr_code.png"
```

### 响应格式

#### 成功响应 (200)
```json
{
  "message": "二维码扫描成功！订单 1 包裹已取出",
  "order_id": 1,
  "status": "PICKED_UP",
  "qr_scanned_at": "2025-08-03T07:32:27.686957+00:00",
  "student_name": "5566"
}
```

#### 错误响应

**400 - 图片格式错误**
```json
{
  "detail": "无法识别二维码，请重新拍照"
}
```

**400 - 二维码已失效**
```json
{
  "detail": "二维码已失效，请使用新的二维码"
}
```

**403 - 签名验证失败**
```json
{
  "detail": "二维码签名验证失败"
}
```

**404 - 订单不存在**
```json
{
  "detail": "订单不存在或学生ID不匹配"
}
```

## 工作流程

### 1. 机器人拍照
- 机器人到达目的地后，使用摄像头拍摄二维码图片
- 确保图片清晰，二维码完整可见

### 2. 上传图片
- 将拍摄的图片通过API上传到服务器
- 服务器自动识别图片中的二维码

### 3. 服务器处理
- **图片识别**: 使用pyzbar库识别二维码内容
- **数据解析**: 解析二维码中的payload和signature
- **签名验证**: 验证二维码签名防止篡改
- **订单匹配**: 根据order_id和student_id匹配订单
- **状态更新**: 更新订单状态为"已取出"
- **二维码失效**: 使二维码失效，防止重复使用

### 4. 返回结果
- 返回处理结果和订单信息
- 记录完整的操作日志

## 安全特性

### 1. 签名验证
- 每个二维码都包含数字签名
- 防止二维码被篡改或伪造

### 2. 一次性使用
- 二维码扫描后立即失效
- 防止重复使用和重放攻击

### 3. 学生验证
- 验证学生ID与订单匹配
- 确保只有正确的学生能取件

### 4. 时间戳
- 二维码包含时间戳信息
- 防止过期二维码的使用

## 错误处理

### 常见错误及解决方案

1. **无法识别二维码**
   - 检查图片是否清晰
   - 确保二维码完整可见
   - 重新拍照上传

2. **二维码已失效**
   - 二维码已被使用过
   - 需要生成新的二维码

3. **签名验证失败**
   - 二维码可能被篡改
   - 使用原始二维码重新扫描

4. **订单不存在**
   - 检查order_id和student_id是否正确
   - 确认订单状态

## 日志记录

所有操作都会记录到系统日志中：
- **成功扫描**: INFO级别日志
- **识别失败**: WARNING级别日志
- **验证失败**: ERROR级别日志

## 测试

可以使用提供的测试脚本进行接口测试：
```bash
python3 test_qr_image_upload.py
```

## 优势

相比小车本地识别二维码的方案：

1. **硬件要求低**: 小车只需要摄像头拍照
2. **处理能力强**: 服务器有更强的计算能力
3. **算法更新方便**: 识别算法可以在服务器端随时更新
4. **错误处理更好**: 服务器可以处理各种异常情况
5. **统一管理**: 所有二维码处理逻辑集中在服务器端
6. **安全性高**: 完整的签名验证和防重放机制 